# Chess Training Bot

A simple chess bot for [lichess.org](https://lichess.org) that plays moves using the lichess opening explorer with the Masters' database. Once we're out of book moves, the bot will try to match the opponent's rating so that you always get a fair game, using Stockfish. The idea is to have a bot that plays into the same lines every time to practise playing specific openings. 

While using the Masters' database, moves are chosen uniformly randomly from the top 5. This allows for some non-determinism in terms of where each game goes, so even within the same lines, slightly different moves will be chosen. This is of course barring the fact that the bot will play into the exact starting position, if for example it requires 3 moves to get there, e.g., the Vienna requires e4 e5 Nc3. The first 10 moves or 20 ply are played using the opening explorer. 

I found that using the complete Lichess database made for a poor choice for this bot since among the top 5 moves in many opening positions, blunders appear quite frequently (almost too frequently!)

## Setup

1. **Install Stockfish, Python dependencies, build the frontend, and prepare the opening book**
   ```bash
   ./setup.sh
   ```
   The helper script first checks whether a Stockfish binary is already available. If not, it will try to install one via `apt-get` (when available) and otherwise prints instructions so you can install it manually and/or set `STOCKFISH_PATH` in your environment. Afterwards the script runs `python -m pip install -r requirements.txt`, builds the local Masters opening database by running the crawler (skipping the crawl if the JSON file already exists), and, when `npm` is present, installs the frontend packages and builds the production bundle. Set `FORCE_REBUILD_OPENING_BOOK=1` when invoking the script to refresh the database from scratch.

   Prefer to run the steps yourself? Install Stockfish using your platform of choice, then run:
   ```bash
   python3 -m pip install -r requirements.txt
   npm install
   npm run build
   ```

2. **Configure your environment**
   Copy `.env_example` to `.env` and replace the token value with your Lichess bot token.

   Note: You will need to create a Lichess BOT account first, see instructions here: https://lichess.org/api#tag/Bot/operation/botAccountUpgrade
   ```bash
   cp .env_example .env
   # edit .env and set LICHESS_BOT_TOKEN
   ```

## Building or refreshing the local opening database

The bot prefers using a local copy of the Lichess Masters opening explorer to avoid repeated API calls and to guarantee consistent move choices. The JSON file (`opening_book.json`) lives at the repository root.

To (re)build the database manually run:

```bash
python -m opening_book.crawler
```

The crawler walks the Masters explorer up to depth 8 by default and may take several minutes. It requires network access and respects the API rate limits by sleeping between bursts of requests. You can safely re-run the command at any time; it resumes from the existing file unless you delete it first.

The setup script (`./setup.sh`) invokes the crawler automatically whenever the file is missing. Pass `FORCE_REBUILD_OPENING_BOOK=1 ./setup.sh` to force a full rebuild.
## Running the bot

Execute the package as a module:

```bash
python -m chess_trainer.trainer
```

You will be prompted to choose preferred openings and the bot will start listening for games on Lichess. Moves will be selected from the Lichess opening explorer when possible and otherwise generated by Stockfish 16.

### Web setup

If you prefer a small web UI instead of the command line prompts run:

```bash
python -m chess_trainer.ui
```

Your browser will open `http://localhost:8000/` where you can pick your preferred openings and enter the username you wish to challenge. If you have no preference, you can leave the form blank (except for the Lichess ID). When you submit the form, the challenge URL from Lichess opens in a new tab so you can accept it. The game page is then opened automatically once Lichess starts the game.

## Files

- `chess_trainer/trainer.py` – main entry point that handles events and engine interaction.
- `chess_trainer/bot_profile.py` – dataclass describing the bot's settings and default openings.
- `chess_trainer/openings_explorer.py` – helper module that queries the opening explorer and filters moves by your preferences.
- `chess_trainer/ui.py` – simple Flask server for configuring and challenging the bot.
- `setup.sh` – locates/installs Stockfish, installs Python packages, and builds the frontend using npm.

Please leave me feedback or suggestions for future improvements, I would really appreciate it :)

Enjoy your training games! 